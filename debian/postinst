#!/bin/bash
set -e
INIFILE=/etc/polaric-aprsd/server.ini


case "$1" in

    configure|reconfigure)
        if [ "$1" == "configure" ] ; then
           if ! id polaric > /dev/null 2>&1 ; then
               adduser --quiet --system --home /var/lib/polaric --no-create-home \
                   --group --disabled-password --shell /bin/false \
                   polaric
               usermod -G dialout polaric
           fi
           chown root:polaric /etc/polaric-aprsd/passwd
           chown root:polaric /etc/polaric-aprsd/keys
           chown root:polaric /etc/polaric-aprsd/keys/*
           chmod 660 /etc/polaric-aprsd/passwd
           chmod 750 /etc/polaric-aprsd/keys
           chmod 640 /etc/polaric-aprsd/keys/*
        
           chown polaric:adm /var/log/polaric
           chown polaric:adm /var/lib/polaric
           chmod 755 /var/log/polaric
           chmod 755 /var/lib/polaric
           chmod 440 /etc/sudoers.d/polaric-aprsd
        fi  
        if [[ ! -e "/var/lib/polaric/users.dat" ]] ; then 
           echo "admin,null,false,true,Admin User,,DEFAULT,false" > /var/lib/polaric/users.dat
           chown polaric:polaric /var/lib/polaric/users.dat
           chmod 644 /var/lib/polaric/users.dat
        fi
        if [[ ! -e "/etc/polaric-aprsd/keys/keystore.jks" ]] ; then 
           polaric-importcert-snakeoil yes
        fi
        
        # Grant CAP_NET_RAW capability to Java for ICMP ping (OfflineDetector)
        # This allows the Java process to send/receive ICMP packets without running as root
        # Note: This capability is set on the Java binary itself, which means all Java
        # processes on this system will have CAP_NET_RAW. This is a standard approach
        # for system-wide Java applications requiring ICMP functionality.
        if [ ! -f "/usr/bin/java" ]; then
            echo "Warning: Java binary not found at /usr/bin/java. OfflineDetector ICMP checks may not work."
        elif ! command -v setcap >/dev/null 2>&1; then
            echo "Warning: setcap command not available. OfflineDetector ICMP checks may not work."
        else
            JAVA_BIN=$(readlink -f /usr/bin/java 2>/dev/null)
            if [ -n "$JAVA_BIN" ] && [ -f "$JAVA_BIN" ]; then
                echo "Granting CAP_NET_RAW capability to Java binary for ICMP support..."
                setcap cap_net_raw+ep "$JAVA_BIN" || echo "Warning: Failed to set capabilities on Java binary. OfflineDetector ICMP checks may not work."
            else
                echo "Warning: Could not resolve Java binary path. OfflineDetector ICMP checks may not work."
            fi
        fi
        
        echo
        echo "******** Polaric-aprsd ********"
        echo "It is recommended to install the polaric-webapp2 package. It can also be used to configure"
        echo "the server. If this is the first time installataion, please set your CALLSIGN and restart!" 
        echo
        echo "Use the command 'polaric-setcall' to set the callsign"
        echo "Use the command 'polaric-restart' to restart server" 
        echo "Use command 'polaric-passwd' to change password or add new users"
        echo 
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "$0 called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

#DEBHELPER#
